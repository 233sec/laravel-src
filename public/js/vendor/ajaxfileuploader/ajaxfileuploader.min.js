
/**
 * ajaxfileuploader.js
 * @homepage:       https://github.com/xiaohuilam/ajaxfileuploader.js
 * @author:         xiaohui.lam(xiaohui.lam#icloud.com)
 * @description:    ajax_upload_file
 * @usage:          see: https://gist.githubusercontent.com/xiaohuilam/2d8959ee8ed31881b6d414bfa593851d/raw/48759ca94d194043eaffd9073dc8b732bdeaab9c/ajaxfileuploader-usage.js
 */
(function(q, b) {
    "undefined" == typeof b.handleError && (b.handleError = function(b) {
        return !1
    }
    );
    b.extend({
        createUploadIframe: function(a, c) {
            var e = "jUploadFrame" + a
              , d = '<iframe id="' + e + '" name="' + e + '" style="position:absolute; top:-9999px; left:-9999px"';
            q.ActiveXObject && ("boolean" == typeof c ? d += ' src="javascript:false"' : "string" == typeof c && (d += ' src="' + c + '"'));
            d += " />";
            b(document.body).append(b(d));
            return b("#" + e).get(0)
        },
        createUploadForm: function(a, c, e) {
            var d = "jUploadForm" + a;
            a = "jUploadFile" + a;
            d = b('<form  action="" method="POST" name="' + d + '" id="' + d + '" enctype="multipart/form-data"></form>');
            if (e)
                for (var h in e)
                    b('<input type="hidden" name="' + h + '" value="' + e[h] + '" />').appendTo(d);
            c = b("#" + c);
            e = b(c).clone();
            b(c).attr("id", a);
            b(c).before(e);
            b(c).appendTo(d);
            b(d).css("position", "absolute");
            b(d).css("top", "-1200px");
            b(d).css("left", "-1200px");
            b(document.body).append(b(d));
            return d
        },
        ajaxFileUpload: function(a, c, e) {
            a = b.extend({}, b.ajaxSettings, a);
            "undefined" === a.filedName && (a.filedName = a.fileElementId);
            var d = (new Date).getTime().toString() + parseInt(9999999 * Math.random()).toString()
              , h = "jUploadFrame" + d
              , k = "jUploadForm" + d
              , l = !1;
            if ("undefined" === typeof c || "undefined" === typeof c.target || "undefined" === typeof c.target.files) {
                var f = b.createUploadForm(d, a.fileElementId, "undefined" == typeof a.data ? !1 : a.data);
                b.createUploadIframe(d, a.secureuri);
                a.global && !b.active++ && b.event.trigger("ajaxStart");
                var g = {};
                a.global && b.event.trigger("ajaxSend", [g, a]);
                var p = function(c) {
                    var d = document.getElementById(h);
                    try {
                        d.contentWindow ? (g.responseText = d.contentWindow.document.body ? d.contentWindow.document.body.innerHTML : null,
                        g.responseXML = d.contentWindow.document.XMLDocument ? d.contentWindow.document.XMLDocument : d.contentWindow.document) : d.contentDocument && (g.responseText = d.contentDocument.document.body ? d.contentDocument.document.body.innerHTML : null,
                        g.responseXML = d.contentDocument.document.XMLDocument ? d.contentDocument.document.XMLDocument : d.contentDocument.document)
                    } catch (m) {
                        b.handleError(a, g, null, m)
                    }
                    if ((text = b("<div>" + g.responseText + "</div>").text()) || "timeout" == c) {
                        l = !0;
                        var e;
                        try {
                            e = "timeout" != c ? "success" : "error",
                            "error" != e ? (b.uploadHttpData(text, a.dataType),
                            a.success && a.success(text, k, a.srcElement),
                            a.global && b.event.trigger("ajaxSuccess", [text, a])) : b.handleError(a, text, e)
                        } catch (m) {
                            b.handleError(a, text, e, m)
                        }
                        a.global && b.event.trigger("ajaxComplete", [text, a]);
                        a.global && !--b.active && b.event.trigger("ajaxStop");
                        a.complete && a.complete(text, e);
                        b(d).unbind();
                        setTimeout(function() {
                            try {
                                b(d).remove(),
                                b(f).remove()
                            } catch (m) {
                                b.handleError(a, text, null, m)
                            }
                        }, 100);
                        text = null
                    }
                };
                0 < a.timeout && setTimeout(function() {
                    l || p("timeout")
                }, a.timeout)
            }
            try {
                if ("undefined" !== typeof c && "undefined" !== typeof c.target && "undefined" !== typeof c.target.files)
                    for (i = 0; i < c.target.files.length; i++)
                        if (nonce = parseInt(99999999 * Math.random()),
                        a.beforeUpload(c.target.files[i], nonce, a.srcElement),
                        c.target.files[i].size > a.maxSize || c.target.files[i].size < a.minSize)
                            a.error(c.target.files[i], nonce, "Filesize Limit exceeded!", a.srcElement);
                        else {
                            var n = new FormData;
                            for (j in a.data)
                                n.append(j, a.data[j]);
                            n.append("file", c.target.files[i]);
                            xmlHTTP = new XMLHttpRequest;
                            xmlHTTP.nonce = nonce;
                            xmlHTTP.file = c.target.files[i];
                            xmlHTTP.open("POST", a.url);
                            xmlHTTP.onreadystatechange = function(b) {
                                if (4 != b.target.readyState)
                                    return !1;
                                try {
                                    eval("var json=" + b.target.responseText)
                                } catch (t) {
                                    return a.error(this.file, b.target.nonce, "Server Error!", a.srcElement),
                                    !1
                                }
                                "undefined" !== typeof a.success && a.success(json, b.target.nonce, a.srcElement);
                                delete json
                            }
                            ;
                            xmlHTTP.send(n);
                            delete n
                        }
                else
                    a.beforeUpload({
                        name: e.split("\\\\").reverse()[0]
                    }, k, a.srcElement),
                    f = b("#" + k),
                    b(f).find('input[type="file"]').attr("name", a.filedName),
                    b(f).attr("action", a.url),
                    b(f).attr("method", "POST"),
                    b(f).attr("target", h),
                    f.encoding ? b(f).attr("encoding", "multipart/form-data") : b(f).attr("enctype", "multipart/form-data"),
                    b(f).submit()
            } catch (r) {
                b.handleError(a, g, null, r)
            }
            b("#" + h).load(p);
            return {
                abort: function() {}
            }
        },
        uploadHttpData: function(a, c) {
            var e;
            e = "xml" != c && c ? a.responseText : a.responseXML;
            "script" == c && b.globalEval(e);
            "json" == c && eval("data = " + e);
            "html" == c && b("<div>").html(e).evalScripts();
            return e
        }
    });
    b.fn.extend({
        uploader: function(a) {
            var c = {
                url: null,
                secureuri: null,
                data: null,
                fileElementId: null,
                filedName: null,
                dataType: "json",
                minSize: 1,
                maxSize: 2097152,
                success: function(b, c, a) {},
                beforeUpload: function(b, c) {},
                allowExt: {
                    jpg: 1,
                    png: 1,
                    gif: 1,
                    jpeg: 1,
                    bmp: 1,
                    ico: 1,
                    webp: 1
                },
                paste: !0
            };
            b.extend(c, a);
            that = this;
            b(document).ready(function() {
                b(that).on("change", function(a) {
                    try {
                        if (that_ext = b(that).val().split(".").reverse()[0],
                        0 < b(that).val().length && ("undefined" === typeof c.allowExt[that_ext] || 1 != c.allowExt[that_ext]))
                            return b(that).val(""),
                            alert("\u6b64\u7c7b\u6587\u4ef6\u4e0d\u5141\u8bb8\u4e0a\u4f20"),
                            !1
                    } catch (d) {
                        return b(that).val(""),
                        alert("\u6b64\u7c7b\u6587\u4ef6\u4e0d\u5141\u8bb8\u4e0a\u4f20"),
                        !1
                    }
                    b.ajaxFileUpload({
                        url: c.url,
                        secureuri: c.secureuri,
                        data: c.data,
                        fileElementId: c.fileElementId,
                        filedName: c.filedName,
                        dataType: c.dataType,
                        minSize: c.minSize,
                        maxSize: c.maxSize,
                        allowExt: c.allowExt,
                        srcElement: b(a.target),
                        success: function(a, e, k) {
                            "string" === typeof a && (a = b.parseJSON(a));
                            if ("undefined" !== typeof c.success)
                                return c.success(a, e, k)
                        },
                        beforeUpload: function(b, a, e) {
                            if ("undefined" !== typeof c.beforeUpload)
                                return c.beforeUpload(b, a, e)
                        },
                        error: function(b, a, e, l) {
                            if ("undefined" !== typeof c.error)
                                return c.error(b, a, e, l)
                        }
                    }, a, b("undefined" !== typeof a.target ? a.target : a.srcElement).val())
                })
            });
            if (c.paste)
                b(document).on("paste", function(a) {
                    a = (a.clipboardData || a.originalEvent.clipboardData).items;
                    if (1 > a.length)
                        return !0;
                    blob = a[0].getAsFile();
                    if ("undefined" === typeof blob || null === blob || !blob)
                        return !0;
                    type = blob.type.replace("image/", "");
                    "jpeg" === type && (type = "jpg");
                    blob.name = "image." + type;
                    nonce = parseInt(99999999 * Math.random());
                    c.beforeUpload(blob, nonce);
                    (blob.size > c.maxSize || blob.size < c.minSize) && c.error(blob, nonce, "Filesize Limit exceeded!", b(this));
                    var d = new FormData;
                    for (j in c.data)
                        d.append(j, c.data[j]);
                    d.append("file", blob, blob.name);
                    var e = new XMLHttpRequest;
                    e.nonce = nonce;
                    e.file = blob;
                    e.open("POST", c.url);
                    e.onreadystatechange = function(a) {
                        if (4 != a.target.readyState)
                            return !0;
                        try {
                            eval("var json=" + a.target.responseText)
                        } catch (l) {
                            return c.error(this.file, this.nonce, "Server Error!"),
                            !0
                        }
                        "undefined" !== typeof c.success && c.success(json, a.target.nonce);
                        delete json
                    }
                    ;
                    e.send(d);
                    delete d;
                    delete a;
                    delete blob;
                    delete nonce;
                    delete type
                })
        }
    })
})(window, jQuery);
